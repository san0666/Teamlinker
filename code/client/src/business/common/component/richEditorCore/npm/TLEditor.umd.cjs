(function(D,f){typeof exports=="object"&&typeof module<"u"?f(exports,require("vue")):typeof define=="function"&&define.amd?define(["exports","vue"],f):(D=typeof globalThis<"u"?globalThis:D||self,f(D.TLEditor={},D.Vue))})(this,function(D,f){"use strict";var ce=Object.defineProperty;var he=(D,f,E)=>f in D?ce(D,f,{enumerable:!0,configurable:!0,writable:!0,value:E}):D[f]=E;var A=(D,f,E)=>(he(D,typeof f!="symbol"?f+"":f,E),E);var E=(x=>(x[x.TEXT=0]="TEXT",x[x.LINK=1]="LINK",x[x.IMAGE=2]="IMAGE",x))(E||{});class T{static handle(t,s){let o="";for(let e of t.arr){let i;if(e.type==E.TEXT)if(e.style&&Object.keys(e.style).length>0){if(i=document.createElement("span"),i.innerText=e.value,e.style)for(let l in e.style)i.style[l]=e.style[l]}else{o+=e.value;continue}else e.type==E.LINK?i=document.createElement("a"):e.type==E.IMAGE?i=document.createElement("img"):i=document.createElement("a"),s==null||s(i,e);i&&(o+=i.outerHTML)}return o}static handleInnerHtml(t,s,o=!1,e){t.selectEndIndexPath=[],t.selectStartIndexPath=[],t.arr=[],s.childNodes.forEach(a=>{var p,m,h,u,y,w,b,L;if(a.nodeType==Node.TEXT_NODE){let M={value:a.nodeValue,style:{},type:E.TEXT};t.arr.push(M)}else if(a.nodeType==Node.ELEMENT_NODE){let M={value:"",style:{}},C=a;C.tagName=="SPAN"?(M.type=E.TEXT,M.value=C.innerText??""):e==null||e(M,C),(p=C.style)!=null&&p.color&&(M.style.color=(m=C.style)==null?void 0:m.color),(h=C.style)!=null&&h.fontStyle&&(M.style.fontStyle=C.style.fontStyle),(u=C.style)!=null&&u.fontWeight&&(M.style.fontWeight=C.style.fontWeight),(y=C.style)!=null&&y.fontSize&&(M.style.fontSize=C.style.fontSize),(w=C.style)!=null&&w.backgroundColor&&(M.style.backgroundColor=(b=C.style)==null?void 0:b.backgroundColor),(L=C.style)!=null&&L.textDecoration&&(M.style.textDecoration=C.style.textDecoration),t.arr.push(M)}});let i=window.getSelection(),l;i.rangeCount>0?l=i.getRangeAt(0):(l=document.createRange(),l.selectNodeContents(s),l.collapse(!1));let n=l.startOffset,r=l.endOffset,c=l.startContainer,d=l.endContainer;if(s.contains(c))if(s==c)c.childNodes.length==0||n>=c.childNodes.length?t.selectStartIndexPath=[n>0?n-1:0,c.childNodes.length==0?0:c.lastChild.textContent?c.lastChild.textContent.length:0]:t.selectStartIndexPath=[n,0];else{t.selectStartIndexPath.unshift(n);let a=c.parentElement;a==s?(n=Array.from(a.childNodes).indexOf(c),t.selectStartIndexPath.unshift(n)):(n=Array.from(a.parentElement.childNodes).indexOf(a),t.selectStartIndexPath.unshift(n))}if(s.contains(d))if(s==d)d.childNodes.length==0||r>=d.childNodes.length?t.selectEndIndexPath=[r>0?r-1:0,d.childNodes.length==0?0:d.lastChild.textContent?d.lastChild.textContent.length:0]:t.selectEndIndexPath=[r,0];else{t.selectEndIndexPath.unshift(r);let a=d.parentElement;a==s?(r=Array.from(a.childNodes).indexOf(d),t.selectEndIndexPath.unshift(r)):(r=Array.from(a.parentElement.childNodes).indexOf(a),t.selectEndIndexPath.unshift(r))}if(o){for(;c.tagName!=="DIV";)c=c.parentElement;for(;d.tagName!=="DIV";)d=d.parentElement;f.nextTick(()=>{if(c==s){let a=c.childNodes[t.selectStartIndexPath[0]];if(!a)return;if(a.nodeType==Node.TEXT_NODE)l.setStart(a,t.selectStartIndexPath[1]);else if(a.nodeType==Node.ELEMENT_NODE)if(a.tagName=="BR"){l.selectNode(a);return}else if(a.tagName=="IMG"){l.selectNode(a),l.collapse(!1);return}else a.contentEditable=="true"&&l.setStart(a.firstChild,t.selectStartIndexPath[1])}if(d==s){let a=d.childNodes[t.selectEndIndexPath[0]];if(!a)return;if(a.nodeType==Node.TEXT_NODE)l.setEnd(a,t.selectEndIndexPath[1]);else if(a.nodeType==Node.ELEMENT_NODE)if(a.tagName=="BR"||a.tagName=="IMG"){l.selectNode(a);return}else a.contentEditable==="true"&&l.setEnd(a.firstChild,t.selectEndIndexPath[1])}})}}static fixLine(t,s){for(let o=1;o<t.arr.length;o++){let e=t.arr[o],i=t.arr[o-1];if(e.style&&i.style&&JSON.stringify(e.style)===JSON.stringify(i.style)&&e.type==i.type&&e.type==E.TEXT||!e.value&&e.type!=E.IMAGE){let l=i.value.length;i.value+=e.value,t.arr.splice(o,1),o--,s&&(f.toRaw(s.startItem)===f.toRaw(e)&&(s.startItem=i,s.startIndex+=l),f.toRaw(s.endItem)===f.toRaw(e)&&(s.endItem=i,s.endIndex+=l))}}for(let o=0;o<t.arr.length;o++){let e=t.arr[o];!e.value&&e.type!=E.IMAGE&&(t.arr.splice(o,1),o--)}}}function Q(x,t){let s=x.getLineList(),o=x.getRoot(),e=x.getSelectElementList();if(e.length==1){let i=s[Array.from(o.value.children).indexOf(e[0])];if(i.selectStartIndexPath.length>0&&i.selectEndIndexPath.length>0){let l;if(i.selectEndIndexPath[0]>i.selectStartIndexPath[0]){let n=i.arr[i.selectStartIndexPath[0]],r=i.arr[i.selectEndIndexPath[0]],c;for(let a=i.selectStartIndexPath[0];a<=i.selectEndIndexPath[0];a++){let p=i.arr[a];p==n?i.selectStartIndexPath[1]>0&&p.link!=t?(c={style:{...p.style},value:p.value.substring(i.selectStartIndexPath[1]),type:E.LINK,link:t},p.value=p.value.substring(0,i.selectStartIndexPath[1]),i.arr.splice(a+1,0,c),a++,i.selectEndIndexPath[0]++,n=c):(p.link=t,p.type=E.LINK,n=p):p==r?(n.value+=p.value.substring(0,i.selectEndIndexPath[1]),p.value=p.value.substring(i.selectEndIndexPath[1])):(n.value+=p.value,i.arr.splice(a,1),a--,i.selectEndIndexPath[0]--)}let d={startItem:n};T.fixLine(i,d),f.nextTick(()=>{let a=window.getSelection(),p=document.createRange(),m=e[0].childNodes[i.arr.indexOf(d.startItem)];p.selectNode(m),a.removeAllRanges(),a.addRange(p)})}else{let n=i.arr[i.selectStartIndexPath[0]];if(!n)return;let r,c=n.value.substring(i.selectStartIndexPath[1],i.selectEndIndexPath[1]),d=n.value.substring(0,i.selectStartIndexPath[1]),a=n.value.substring(i.selectEndIndexPath[1]);n.value=d,l={value:c,style:{...n.style},type:E.LINK,link:t},i.arr.splice(i.selectStartIndexPath[0]+1,0,l,{value:a,style:{...n.style},type:n.type,...n.link&&{link:n.link}}),T.fixLine(i),r=l,f.nextTick(()=>{let p=window.getSelection(),m=document.createRange(),h=e[0].childNodes[i.arr.indexOf(r)];h&&(m.selectNode(h),p.removeAllRanges(),p.addRange(m))})}}}}function W(x,t,s){let o=x.getLineList(),e=x.getRoot(),i=x.getSelectElementList();if(i.length==1){let l=o[Array.from(e.value.children).indexOf(i[0])];if(T.handleInnerHtml(l,e.value.children[o.indexOf(l)],!1,x.onGetLineConfigType),l.arr.length==0){let n={type:E.IMAGE,link:t,value:"",width:s};l.arr.push(n)}else{let n=l.arr[l.selectStartIndexPath[0]],r={type:E.IMAGE,value:"",link:t,width:s},c=JSON.parse(JSON.stringify(n));c.type==E.IMAGE?l.arr.splice(l.selectStartIndexPath[0]+1,0,r):(c.value=c.value.substring(l.selectStartIndexPath[1]),n.value=n.value.substring(0,l.selectStartIndexPath[1]),l.arr.splice(l.selectStartIndexPath[0]+1,0,r,c))}}}function j(x,t,s){let o=x.getLineList(),e=x.getRoot(),i=x.getSelectElementList();if(i.length==1){let l=o[Array.from(e.value.children).indexOf(i[0])];if(l.selectStartIndexPath.length>0&&l.selectEndIndexPath.length>0){let n;if(l.selectEndIndexPath[0]>l.selectStartIndexPath[0]){let r=l.arr[l.selectStartIndexPath[0]],c=l.arr[l.selectEndIndexPath[0]],d,a;for(let m=l.selectStartIndexPath[0];m<=l.selectEndIndexPath[0];m++){let h=l.arr[m];if(h==r)if(l.selectStartIndexPath[1]>0&&h.style[t]!=s){let u;if(s)u={style:Object.assign({},h.style,{[t]:s}),value:h.value.substring(l.selectStartIndexPath[1]),type:E.TEXT};else{let y={...h.style};delete y[t],u={style:y,value:h.value.substring(l.selectStartIndexPath[1]),type:E.TEXT}}h.value=h.value.substring(0,l.selectStartIndexPath[1]),l.arr.splice(m+1,0,u),m++,l.selectEndIndexPath[0]++,r=u,d=0}else s?Object.assign(h.style,h.style,{[t]:s}):delete h.style[t],r=h,d=l.selectStartIndexPath[1];else if(h==c)if(l.selectEndIndexPath[1]<h.value.length&&h.style[t]!=s){let u;if(s)u={style:Object.assign({},h.style,{[t]:s}),value:h.value.substring(0,l.selectEndIndexPath[1]),type:E.TEXT};else{let y={...h.style};delete y[t],u={style:y,value:h.value.substring(0,l.selectEndIndexPath[1]),type:E.TEXT}}h.value=h.value.substring(l.selectEndIndexPath[1]),l.arr.splice(m,0,u),m++,l.selectEndIndexPath[0]++,c=u,a=u.value.length}else s?Object.assign(h.style,h.style,{[t]:s}):delete h.style[t],c=h,a=l.selectEndIndexPath[1];else s?Object.assign(h.style,h.style,{[t]:s}):delete h.style[t]}let p={startItem:r,endItem:c,startIndex:d,endIndex:a};T.fixLine(l,p),f.nextTick(()=>{let m=window.getSelection(),h=document.createRange(),u=i[0].childNodes[l.arr.indexOf(p.startItem)],y=i[0].childNodes[l.arr.indexOf(p.endItem)];u.nodeType==Node.TEXT_NODE?h.setStart(u,p.startIndex):u.nodeType==Node.ELEMENT_NODE&&(u.tagName=="IMG"?h.setStartBefore(u):h.setStart(u.firstChild,p.startIndex)),y.nodeType==Node.TEXT_NODE?h.setEnd(y,p.endIndex):y.nodeType==Node.ELEMENT_NODE&&(y.tagName=="IMG"?h.setEndAfter(y):h.setEnd(y.firstChild,p.endIndex)),m.removeAllRanges(),m.addRange(h)})}else{let r=l.arr[l.selectStartIndexPath[0]];if(!r)return;let c,d,a;if(r.style[t]!=s){let p=r.value.substring(l.selectStartIndexPath[1],l.selectEndIndexPath[1]),m=r.value.substring(0,l.selectStartIndexPath[1]),h=r.value.substring(l.selectEndIndexPath[1]);if(r.value=m,s)n=JSON.parse(JSON.stringify(r)),n.value=p,n.style=Object.assign({},r.style,{[t]:s});else{n=JSON.parse(JSON.stringify(r));let u={...r.style};delete u[t],n.value=p,n.style=u}l.arr.splice(l.selectStartIndexPath[0]+1,0,n,{value:h,style:{...r.style},type:E.TEXT}),T.fixLine(l),c=0,d=n.value.length,a=n}else a=r,c=l.selectStartIndexPath[1],d=l.selectEndIndexPath[1];f.nextTick(()=>{let p=window.getSelection(),m=document.createRange(),h=i[0].childNodes[l.arr.indexOf(a)];h&&(h.nodeType==Node.TEXT_NODE?(m.setStart(h,c),m.setEnd(h,d)):h.nodeType==Node.ELEMENT_NODE&&(h.tagName=="IMG"?m.selectNode(h):(m.setStart(h.firstChild,c),m.setEnd(h.firstChild,d))),p.removeAllRanges(),p.addRange(m))})}}}else if(i.length>1){let l=[];i.forEach(N=>{l.push(o[Array.from(e.value.children).indexOf(N)])});let n=window.getSelection(),r=n.getRangeAt(0),c=r.startOffset,d=r.endOffset,a=r.startContainer,p=r.endContainer,m=[],h=[];if(a.tagName=="DIV")m=[c,0];else{m.unshift(c);let N=a.parentElement;N.tagName=="DIV"?(c=Array.from(N.childNodes).indexOf(a),m.unshift(c)):(c=Array.from(N.parentElement.childNodes).indexOf(N),m.unshift(c))}if(p.tagName=="DIV")h=[d,p.childNodes[d].textContent.length];else{h.unshift(d);let N=p.parentElement;N.tagName=="DIV"?(d=Array.from(N.childNodes).indexOf(p),h.unshift(d)):(d=Array.from(N.parentElement.childNodes).indexOf(N),h.unshift(d))}let u=l[0],y=l[l.length-1],w=u.arr[m[0]],b=y.arr[h[0]],L=w,M=b,C,F;for(let N of l)if(N==u)for(let O=m[0];O<u.arr.length;O++){let P=u.arr[O];if(P.style[t]!=s)if(P==w){let H;if(s)H={value:P.value.substring(m[1]),style:{...P.style,[t]:s},type:E.TEXT};else{let V={...P.style};delete V[t],H={value:P.value.substring(m[1]),style:V,type:E.TEXT}}P.value=P.value.substring(0,m[1]),u.arr.splice(O+1,0,H),O++,L=H,C=0}else s?P.style[t]=s:delete P.style[t];else P==w&&(C=m[1])}else if(N==y)for(let O=0;O<=h[0];O++){let P=y.arr[O];if(P.style[t]!=s)if(P==b){let H;if(s)H={value:P.value.substring(0,h[1]),style:{...P.style,[t]:s},type:E.TEXT};else{let V={...P.style};delete V[t],H={value:P.value.substring(0,h[1]),style:V,type:E.TEXT}}P.value=P.value.substring(h[1]),y.arr.splice(O,0,H),M=H,F=H.value.length}else s?P.style[t]=s:delete P.style[t];else P==b&&(F=h[1])}else N.arr.forEach(O=>{O.style[t]!=s&&(s?O.style[t]=s:delete O.style[t])});let G={startItem:L,startIndex:C},z={endItem:M,endIndex:F};for(let N of l)N==u?T.fixLine(N,G):N==y?T.fixLine(N,z):T.fixLine(N);f.nextTick(()=>{let N=i[0].childNodes[u.arr.indexOf(G.startItem)],O=i[i.length-1].childNodes[y.arr.indexOf(z.endItem)];N.nodeType==Node.TEXT_NODE?r.setStart(N,G.startIndex):N.nodeType==Node.ELEMENT_NODE&&(N.tagName=="IMG"?r.setStartBefore(N):r.setStart(N.firstChild,G.startIndex)),O.nodeType==Node.TEXT_NODE?r.setEnd(O,z.endIndex):O.nodeType==Node.ELEMENT_NODE&&(O.tagName=="IMG"?r.setEndAfter(O):r.setEnd(O.firstChild,z.endIndex)),n.removeAllRanges(),n.addRange(r)})}}function K(x,t,s){let o=[];x.getSelectionItemList().forEach(e=>{o.push(...e.data.filter(i=>i.type===E.TEXT||i.type===E.LINK))});for(let e of o)if(!e.style||e.style[t]!=s)return!1;return!0}class _{static isBold(t){return K(t,"fontWeight","bold")}static bold(t,s){j(t,"fontWeight",s?"bold":void 0)}static isItalic(t){return K(t,"fontStyle","italic")}static italic(t,s){j(t,"fontStyle",s?"italic":void 0)}static isUnderLine(t){return K(t,"textDecoration","underline")}static underLine(t,s){j(t,"textDecoration",s?"underline":void 0)}static isDeleteLine(t){return K(t,"textDecoration","line-through")}static deleteLine(t,s){j(t,"textDecoration",s?"line-through":void 0)}static fontSize(t,s){j(t,"fontSize",s)}static color(t,s){j(t,"color",s)}static backgroundColor(t,s){j(t,"backgroundColor",s)}static link(t,s){Q(t,s)}static image(t,s){let o=document.createElement("img");o.src=s,o.onload=()=>{W(t,s,o.width),o=null}}}let B;function $(x){var s,o,e;let t=(s=window.getSelection())==null?void 0:s.getRangeAt(0);if(x.key==="Backspace"&&B&&t&&((o=B.getRoot().value)!=null&&o.contains(t.commonAncestorContainer))&&B.getSelectElementList().length>0&&!((e=window.getSelection().getRangeAt(0))!=null&&e.collapsed)){x.preventDefault(),x.stopPropagation();let i=B.getSelectionItemList(),l={startItem:null,startIndex:0};if(i.length==1){let n=i[0].line,r=n.arr[n.selectStartIndexPath[0]],c=n.arr[n.selectEndIndexPath[0]];if(r===c){if(r.type===E.TEXT||r.type===E.LINK){let d=r.value.substring(0,n.selectStartIndexPath[1]),a=r.value.substring(n.selectEndIndexPath[1]);r.value=d+a}else n.arr.splice(n.selectStartIndexPath[0],1);l.startItem=r,l.startIndex=n.selectStartIndexPath[1]}else for(let d of i[0].data)d===r?(r.type===E.TEXT||r.type===E.LINK?r.value=r.value.substring(0,n.selectStartIndexPath[1]):n.arr.splice(n.arr.indexOf(r),1),l.startItem=r,l.startIndex=n.selectStartIndexPath[1]):d===c?c.type===E.TEXT||c.type===E.LINK?c.value=c.value.substring(n.selectEndIndexPath[1]):n.arr.splice(n.arr.indexOf(c),1):n.arr.splice(n.arr.indexOf(d),1);T.fixLine(n,l)}else{let n;for(let r=0;r<i.length;r++){let c=i[r],d=c.line;if(r==0||r==i.length-1)if(r==0){n=d;for(let a=0;a<c.data.length;a++){let p=c.data[a];a==0&&(p.type===E.TEXT||p.type===E.LINK)?p.value=p.value.substring(0,d.selectStartIndexPath[1]):d.arr.splice(d.arr.indexOf(p),1)}}else{for(let a=0;a<c.data.length;a++){let p=c.data[a];a==c.data.length-1&&(p.type===E.TEXT||p.type===E.LINK)?p.value=p.value.substring(d.selectEndIndexPath[1]):d.arr.splice(d.arr.indexOf(p),1)}n.arr=n.arr.concat(d.arr),B.getLineList().splice(B.getLineList().indexOf(d),1),T.fixLine(n)}else B.getLineList().splice(B.getLineList().indexOf(d),1)}}f.nextTick(()=>{let n=window.getSelection(),r=document.createRange(),c=B.getLineList().indexOf(i[0].line),d=B.getRoot().value.children[c].childNodes[i[0].line.selectStartIndexPath[0]];if(d){if(d.nodeType===Node.TEXT_NODE||d.tagName==="SPAN"){let a=d.tagName==="SPAN"?d.innerText:d.textContent;i[0].line.selectStartIndexPath[1]>=a.length?(r.setStartAfter(d),r.setEndAfter(d)):(r.setStart(d,i[0].line.selectStartIndexPath[1]),r.setEnd(d,i[0].line.selectStartIndexPath[1]))}else r.setStartAfter(d),r.setEndAfter(d);n.removeAllRanges(),n.addRange(r);for(let a of B.getSelectElementList())a.contentEditable="true";B.setSelectElementList([])}})}}class Y{constructor(t,s,o){A(this,"selectElementList",[]);A(this,"isMouseDown",!1);A(this,"root");A(this,"lineList",f.reactive([]));A(this,"imageHelperElement");A(this,"resizeImage");A(this,"resizeObserver");A(this,"selectionMenuElement");A(this,"selectionTextElement");A(this,"selectionLinkElement");A(this,"selectionColorElement");A(this,"linkEditElement");A(this,"popMenuPosition");A(this,"quotePosition");A(this,"destroyFunc");A(this,"destroyQuoteFunc");A(this,"onUploadFileFunc");A(this,"onPopMenuClickFunc");A(this,"onCustomMenuClickFunc");A(this,"onQuoteListFunc");A(this,"onSetLineConfigType");A(this,"onGetLineConfigType");this.root=t,this.popMenuPosition=s,this.quotePosition=o,document.addEventListener("keydown",$)}setSelectElementList(t){this.selectElementList=t}clear(){var t,s,o,e,i,l;(t=this.destroyFunc)==null||t.call(this),(s=this.destroyQuoteFunc)==null||s.call(this),(o=this.imageHelperElement)==null||o.remove(),(e=this.resizeObserver)==null||e.disconnect(),(i=this.selectionMenuElement)==null||i.remove(),(l=this.linkEditElement)==null||l.remove(),this.popMenuPosition.value=null,this.quotePosition.value=null}clearQuote(){this.quotePosition.value=null}getLineList(){return this.lineList}setLineList(t){this.lineList.splice(0,this.lineList.length,...t)}getSelectElementList(){return this.selectElementList}getRoot(){return this.root}addLine(t,s){let o={arr:[{value:t,...s,type:E.TEXT}],selectEndIndexPath:[],selectStartIndexPath:[]};this.lineList.push(o)}onFocus(t,s){B=this,this.selectElementList.length==0&&(this.selectElementList=[s.currentTarget])}onDbClick(t){this.selectElementList=[t.currentTarget]}onBlur(t,s){T.handleInnerHtml(t,s.currentTarget,!0,this.onGetLineConfigType),this.selectionMenuElement&&!this.selectionMenuElement.contains(s.relatedTarget)&&!this.selectionLinkElement.contains(s.relatedTarget)&&(this.selectionMenuElement.style.display="none"),this.imageHelperElement&&(this.imageHelperElement.style.display="none",this.resizeObserver.unobserve(this.imageHelperElement),this.resizeImage=null),this.popMenuPosition.value=null}onEnter(t,s,o){o.preventDefault(),o.stopPropagation(),T.handleInnerHtml(t,o.currentTarget,!1,this.onGetLineConfigType);let e=t.arr[t.selectStartIndexPath[0]],i={arr:t.arr.slice(t.selectStartIndexPath[0]+1),selectStartIndexPath:[],selectEndIndexPath:[]};if(!e||e.type===E.TEXT||e.type===E.LINK){let l=e==null?void 0:e.value.substring(t.selectStartIndexPath[1]);l?(i.arr.unshift({value:l,style:{...e.style},type:E.TEXT}),e.value=e.value.substring(0,t.selectStartIndexPath[1])):i.arr.unshift({value:"",style:{},type:E.TEXT})}t.arr.splice(t.selectStartIndexPath[0]+1),this.lineList.splice(s+1,0,i),f.nextTick(()=>{this.selectElementList=[this.root.value.children[s+1]];let l=this.root.value.children[s+1],n=window.getSelection(),r=document.createRange();r.selectNodeContents(l),r.collapse(!0),n.removeAllRanges(),n.addRange(r)})}onDelete(t,s,o){let e=o.currentTarget,l=window.getSelection().getRangeAt(0),n=l.startOffset,r=l.endOffset,c=l.startContainer,d=c,a=l.endContainer,p=a,m=[],h=[];if(c.tagName=="DIV")m=[0,n];else{m.unshift(n);let u=c.parentElement;u.tagName=="DIV"?(n=Array.from(u.childNodes).indexOf(c),m.unshift(n),c=u):(n=Array.from(u.parentElement.childNodes).indexOf(u),m.unshift(n),c=u.parentElement)}if(a.tagName=="DIV")h=[0,r];else{h.unshift(r);let u=a.parentElement;u.tagName=="DIV"?(r=Array.from(u.childNodes).indexOf(a),h.unshift(r),a=u):(r=Array.from(u.parentElement.childNodes).indexOf(u),h.unshift(r),a=u.parentElement)}if(m[0]==0&&m[1]==0&&h[0]==0&&h[1]==0&&d==p&&t>0){o.preventDefault(),o.stopPropagation(),T.handleInnerHtml(s,e,!1,this.onGetLineConfigType);let u=this.lineList[t-1];s.arr=s.arr.filter(w=>w.value.length>0||w.type===E.IMAGE);let y=[u.arr.length-1>=0?u.arr.length-1:0,u.arr.length>0?u.arr[u.arr.length-1].value.length:0];u.arr=u.arr.concat(s.arr),this.lineList.splice(t,1),T.fixLine(u),f.nextTick(()=>{let w=window.getSelection(),b=document.createRange(),L=this.root.value.children[t-1].childNodes[y[0]];if(L)L.nodeType==Node.TEXT_NODE?(b.setStart(L,y[1]),b.setEnd(L,y[1])):L.nodeType==Node.ELEMENT_NODE&&(L.tagName=="IMG"||L.tagName=="A"?(b.selectNode(L),b.collapse(!1)):(b.setStart(L.firstChild,y[1]),b.setEnd(L.firstChild,y[1])));else{let M=this.root.value.children[t-1];b.selectNodeContents(M),b.collapse(!0)}w.removeAllRanges(),w.addRange(b)})}}onMouseDown(t){this.popMenuPosition.value=null,this.clearQuote(),t.detail==1&&(this.selectElementList=[t.currentTarget],this.isMouseDown=!0)}onMouseMove(t){let s=t.currentTarget;if(this.isMouseDown&&!this.selectElementList.includes(s)){this.selectElementList.push(s);for(let o of this.selectElementList)o.innerHTML!==""&&(o.contentEditable="false")}}onMouseUp(t){this.isMouseDown=!1;let s=window.getSelection();if(s.rangeCount==0)return;let o=s.getRangeAt(0);if(this.selectElementList.length>0){o=o.cloneRange();for(let n of this.selectElementList)f.nextTick(()=>{n.contentEditable="true"});let e=o.startContainer;for(;e.tagName!=="DIV";)e=e.parentElement;let i=o.endContainer;for(;i.tagName!=="DIV";)i=i.parentElement;let l=Array.from(this.root.value.children);this.selectElementList=[];for(let n=l.indexOf(e);n<=l.indexOf(i);n++)this.selectElementList.push(l[n]);s.removeAllRanges(),s.addRange(o),this.handleMenu(t,o)}}onClick(t){var o;let s=t.target;if(s.tagName==="A"||s.parentElement.tagName==="A"){let e;s.tagName==="A"?e=s:s.parentElement.tagName==="A"&&(e=s.parentElement);let i=e.getAttribute("type");i&&((o=this.onCustomMenuClickFunc)==null||o.call(this,Number(i),e.getAttribute("value"),e.getAttribute("link"),e.innerText))}}generatorSelectionMenu(t){let s=t.offsetParent;this.selectionMenuElement=document.createElement("div"),this.selectionMenuElement.tabIndex=-1,this.selectionMenuElement.style.position="absolute",this.selectionMenuElement.style.borderRadius="5px",this.selectionMenuElement.style.boxShadow="0px 0px 2px 2px rgba(169, 169, 169, 0.2)",this.selectionMenuElement.style.backgroundColor="white",this.selectionMenuElement.style.border="1px solid rgba(169, 169, 169, 0.2)";let o=document.createElement("span");o.setAttribute("name","text"),o.style.cursor="pointer",o.style.display="inline-block",o.style.width="50px",o.style.height="30px",o.style.textAlign="center",o.style.lineHeight="30px",o.style.borderRight="1px solid lightgray",o.innerText="Text",o.onmouseenter=()=>{this.selectionTextElement.style.display="block",this.selectionTextElement.style.left=this.selectionMenuElement.offsetLeft+"px",this.selectionTextElement.style.top=this.selectionMenuElement.offsetTop+this.selectionMenuElement.offsetHeight-2+"px"},o.onmouseleave=d=>{let a=d.relatedTarget;(!a||!this.selectionTextElement.contains(a))&&(this.selectionTextElement.style.display="none")},this.selectionMenuElement.appendChild(o);let e=document.createElement("button");e.setAttribute("name","bold"),e.style.cursor="pointer",e.style.width="30px",e.style.height="30px",e.style.textAlign="center",e.style.lineHeight="30px",e.style.fontWeight="bold",e.style.backgroundColor="transparent",e.style.border="0px",e.innerText="B",e.onclick=()=>{_.bold(this,e.style.color=="black"),e.style.color=e.style.color=="black"?"blue":"black"},this.selectionMenuElement.appendChild(e);let i=document.createElement("button");i.setAttribute("name","italic"),i.style.cursor="pointer",i.style.width="30px",i.style.height="30px",i.style.textAlign="center",i.style.lineHeight="30px",i.style.fontStyle="italic",i.style.backgroundColor="transparent",i.style.border="0px",i.innerText="I",i.onclick=()=>{_.italic(this,i.style.color=="black"),i.style.color=i.style.color=="black"?"blue":"black"},this.selectionMenuElement.appendChild(i);let l=document.createElement("button");l.setAttribute("name","underline"),l.style.cursor="pointer",l.style.width="30px",l.style.height="30px",l.style.textAlign="center",l.style.lineHeight="30px",l.style.textDecoration="underline",l.style.backgroundColor="transparent",l.style.border="0px",l.innerText="U",l.onclick=()=>{_.underLine(this,l.style.color=="black"),l.style.color=l.style.color=="black"?"blue":"black"},this.selectionMenuElement.appendChild(l);let n=document.createElement("button");n.setAttribute("name","lineThrough"),n.style.cursor="pointer",n.style.width="30px",n.style.height="30px",n.style.textAlign="center",n.style.lineHeight="30px",n.style.textDecoration="line-through",n.style.backgroundColor="transparent",n.style.border="0px",n.innerText="S",n.onclick=()=>{_.deleteLine(this,n.style.color=="black"),n.style.color=n.style.color=="black"?"blue":"black"},this.selectionMenuElement.appendChild(n);let r=document.createElement("span");r.setAttribute("name","color"),r.style.cursor="pointer",r.style.display="inline-block",r.style.width="30px",r.style.height="30px",r.style.textAlign="center",r.style.lineHeight="30px",r.innerText="A",r.onmouseenter=()=>{this.selectionColorElement.style.display="block",this.selectionColorElement.style.left=this.selectionMenuElement.offsetLeft+r.offsetLeft-100+"px",this.selectionColorElement.style.top=this.selectionMenuElement.offsetTop+this.selectionMenuElement.offsetHeight-2+"px"},r.onmouseleave=d=>{let a=d.relatedTarget;(!a||!this.selectionColorElement.contains(a))&&(this.selectionColorElement.style.display="none")},this.selectionMenuElement.appendChild(r);let c=document.createElement("span");c.setAttribute("name","link"),c.style.cursor="pointer",c.style.display="inline-block",c.style.width="50px",c.style.height="30px",c.style.textAlign="center",c.style.lineHeight="30px",c.innerText="Link",c.onmouseenter=()=>{this.selectionLinkElement.style.display="block",this.selectionLinkElement.style.left=this.selectionMenuElement.offsetLeft+c.offsetLeft-100+"px",this.selectionLinkElement.style.top=this.selectionMenuElement.offsetTop+this.selectionMenuElement.offsetHeight-2+"px",this.selectionLinkElement.querySelector("input").value=""},c.onmouseleave=d=>{let a=d.relatedTarget;(!a||!this.selectionLinkElement.contains(a))&&(this.selectionLinkElement.style.display="none")},this.selectionMenuElement.appendChild(c),s.appendChild(this.selectionMenuElement)}generatorSelectionColor(t){let s=t.offsetParent;this.selectionColorElement=document.createElement("div"),this.selectionColorElement.style.position="absolute",this.selectionColorElement.setAttribute("name","colorList"),this.selectionColorElement.style.display="none",this.selectionColorElement.appendChild(document.createTextNode("Text Color")),this.selectionColorElement.style.borderRadius="5px",this.selectionColorElement.style.boxShadow="0px 0px 2px 2px rgba(169, 169, 169, 0.2)",this.selectionColorElement.style.backgroundColor="white",this.selectionColorElement.style.border="1px solid rgba(169, 169, 169, 0.2)",this.selectionColorElement.style.width="200px",this.selectionColorElement.style.padding="5px",this.selectionColorElement.style.color="gray",this.selectionColorElement.style.fontSize="14px",this.selectionColorElement.onmouseleave=()=>{this.selectionColorElement.style.display="none"};let o=document.createElement("div");o.style.display="flex",o.style.flexWrap="wrap",o.style.marginTop="5px",o.style.marginBottom="10px";let e=["black","red","blue","green","yellow","gray","brown","orange","pink","purple"];for(let n of e){let r=document.createElement("button");r.style.cursor="pointer",r.style.width="25px",r.style.height="25px",r.style.textAlign="center",r.style.lineHeight="25px",r.style.backgroundColor="transparent",r.style.border="1px solid lightgray",r.style.color=n,r.style.marginRight="5px",r.style.marginTop="5px",r.style.borderRadius="5px",r.innerText="A",r.onclick=()=>{_.color(this,n),this.selectionColorElement.style.display="none"},o.appendChild(r)}this.selectionColorElement.appendChild(o),this.selectionColorElement.appendChild(document.createTextNode("Background Color"));let i=document.createElement("div");i.style.display="flex",i.style.flexWrap="wrap",i.style.marginTop="5px";let l=["transparent","red","blue","green","yellow","gray","brown","orange","pink","purple"];for(let n of l){let r=document.createElement("button");r.style.cursor="pointer",r.style.width="25px",r.style.height="25px",r.style.marginRight="5px",r.style.marginTop="5px",r.style.border="0px",r.style.borderRadius="5px",n!="transparent"&&(r.style.backgroundColor=n),r.onclick=()=>{_.backgroundColor(this,n),this.selectionColorElement.style.display="none"},i.appendChild(r)}this.selectionColorElement.appendChild(i),s.appendChild(this.selectionColorElement)}generatorSelectionText(t){let s=t.offsetParent;this.selectionTextElement=document.createElement("div"),this.selectionTextElement.setAttribute("name","fontSizeList"),this.selectionTextElement.style.display="none",this.selectionTextElement.style.flexDirection="column",this.selectionTextElement.style.width="60px",this.selectionTextElement.style.position="absolute",this.selectionTextElement.style.borderRadius="5px",this.selectionTextElement.style.boxShadow="0px 0px 2px 2px rgba(169, 169, 169, 0.2)",this.selectionTextElement.style.backgroundColor="white",this.selectionTextElement.style.border="1px solid rgba(169, 169, 169, 0.2)",this.selectionTextElement.onmouseleave=()=>{this.selectionTextElement.style.display="none"};for(let o=16;o<=48;o+=8){let e=document.createElement("button");e.style.cursor="pointer",e.style.width="100%",e.style.height="30px",e.style.textAlign="center",e.style.lineHeight="30px",e.style.backgroundColor="transparent",e.style.border="0px",o==16?e.innerText="Normal":o==24?e.innerText="H4":o==32?e.innerText="H3":o==40?e.innerText="H2":o==48&&(e.innerText="H1"),e.onclick=()=>{_.fontSize(this,String(o)+"px"),this.selectionTextElement.style.display="none"},this.selectionTextElement.appendChild(e)}s.appendChild(this.selectionTextElement)}generatorSelectionLink(t){let s=t.offsetParent;this.selectionLinkElement=document.createElement("div"),this.selectionLinkElement.setAttribute("name","link"),this.selectionLinkElement.style.display="none",this.selectionLinkElement.style.position="absolute",this.selectionLinkElement.style.borderRadius="5px",this.selectionLinkElement.style.boxShadow="0px 0px 2px 2px rgba(169, 169, 169, 0.2)",this.selectionLinkElement.style.backgroundColor="white",this.selectionLinkElement.style.border="1px solid rgba(169, 169, 169, 0.2)",this.selectionLinkElement.style.padding="5px",this.selectionLinkElement.onmouseleave=()=>{this.selectionLinkElement.style.display="none"};let o=document.createElement("input");o.placeholder="type your link";let e=document.createElement("button");e.innerText="save",e.style.backgroundColor="transparent",e.style.border="0px",e.style.marginLeft="10px",e.onclick=()=>{o.value&&(_.link(this,o.value),this.selectionLinkElement.style.display="none")},this.selectionLinkElement.appendChild(o),this.selectionLinkElement.appendChild(e),s.appendChild(this.selectionLinkElement)}generatorLinkEdit(t){let s=t.offsetParent;this.linkEditElement=document.createElement("div"),this.linkEditElement.setAttribute("name","linkEdit"),this.linkEditElement.style.display="none",this.linkEditElement.style.position="absolute",this.linkEditElement.style.borderRadius="5px",this.linkEditElement.style.boxShadow="0px 0px 2px 2px rgba(169, 169, 169, 0.2)",this.linkEditElement.style.backgroundColor="white",this.linkEditElement.style.border="1px solid rgba(169, 169, 169, 0.2)",this.linkEditElement.style.padding="5px",this.linkEditElement.style.color="gray",this.linkEditElement.style.fontSize="14px",this.linkEditElement.onmouseleave=()=>{this.linkEditElement.style.display="none"},this.linkEditElement.appendChild(document.createTextNode("uri")),this.linkEditElement.appendChild(document.createElement("br"));let o=document.createElement("input");o.style.marginTop="5px",o.style.marginBottom="10px",o.style.width="90%",o.placeholder="type your link",this.linkEditElement.appendChild(o),this.linkEditElement.appendChild(document.createElement("br")),this.linkEditElement.appendChild(document.createTextNode("title")),this.linkEditElement.appendChild(document.createElement("br"));let e=document.createElement("input");e.placeholder="type your title",e.style.marginTop="5px",e.style.width="90%",this.linkEditElement.appendChild(e);let i=document.createElement("button");i.setAttribute("name","save"),i.innerText="save",i.style.borderRadius="5px",i.style.border="0px",i.style.marginTop="10px",i.style.width="100%",i.style.height="25px",this.linkEditElement.appendChild(i),this.linkEditElement.appendChild(document.createElement("br"));let l=document.createElement("button");l.setAttribute("name","remove"),l.innerText="remove",l.style.borderRadius="5px",l.style.border="0px",l.style.marginTop="10px",l.style.width="100%",l.style.height="25px",this.linkEditElement.appendChild(l),s.appendChild(this.linkEditElement)}handleMenu(t,s){if(s.collapsed){this.selectionMenuElement&&(this.selectionMenuElement.style.display="none");let o=t.target;if(o.tagName=="A"&&o.getAttribute("target")){this.linkEditElement||this.generatorLinkEdit(o);let e=o.parentElement,i=Array.from(e.childNodes).indexOf(o),l=Array.from(this.root.value.children).indexOf(e),n=this.lineList[l].arr[i];this.linkEditElement.style.display="block";let r=s.getBoundingClientRect(),d=t.target.offsetParent.getBoundingClientRect(),a=r.left-d.left;r.top-d.top;let p=r.bottom-d.top,m=a-10,h=p+10;m<0&&(m=0),this.linkEditElement.style.left=m+"px",this.linkEditElement.style.top=h+"px";let u=this.linkEditElement.querySelectorAll("input")[0];u.value=n.link;let y=this.linkEditElement.querySelectorAll("input")[1];y.value=n.value;let w=this.linkEditElement.querySelector("[name='save']");w.onclick=()=>{let L=this.lineList[l].arr[i],M=u.value,C=y.value;!M||!C||(L.link=M,L.value=C,this.linkEditElement.style.display="none")};let b=this.linkEditElement.querySelector("[name='remove']");b.onclick=()=>{let L=this.lineList[l].arr[i];L.type=E.TEXT,delete L.link,T.fixLine(this.lineList[l]),this.linkEditElement.style.display="none"}}}else{if(!this.selectionMenuElement){let y=t.target;this.generatorSelectionMenu(y),this.generatorSelectionText(y),this.generatorSelectionColor(y),this.generatorSelectionLink(y)}this.selectionMenuElement.style.display="block";let o=s.getBoundingClientRect(),i=t.target.offsetParent.getBoundingClientRect(),l=o.left-i.left,n=o.top-i.top,r=o.bottom-i.top,c=l-10,d=n-40;c<0&&(c=l),d<0&&(d=r+10),this.selectionMenuElement.style.left=c+"px",this.selectionMenuElement.style.top=d+"px";let a=_.isBold(this),p=_.isItalic(this),m=_.isUnderLine(this),h=_.isDeleteLine(this),u=this.selectionMenuElement.querySelector("[name='bold']");u.style.color=a?"blue":"black",u=this.selectionMenuElement.querySelector("[name='italic']"),u.style.color=p?"blue":"black",u=this.selectionMenuElement.querySelector("[name='underline']"),u.style.color=m?"blue":"black",u=this.selectionMenuElement.querySelector("[name='lineThrough']"),u.style.color=h?"blue":"black"}}onCopy(t){const s=window.getSelection().getRangeAt(0);s.startContainer.nodeType===Node.TEXT_NODE&&s.startContainer.parentElement.tagName==="A"&&s.setStartBefore(s.startContainer.parentElement);const o=s.cloneContents(),e=document.createElement("div");e.setAttribute("copy","teamlinker"),e.appendChild(o),t.clipboardData.setData("text/html",e.outerHTML),t.clipboardData.setData("text/plain",e.innerText),t.preventDefault(),t.stopPropagation()}onPaste(t){var o;let s=t.clipboardData.types;if(this.getSelectElementList(),s.includes("Files")){let e=t.clipboardData.files[0];if(e){let i=window.getSelection(),n=i.getRangeAt(0).startContainer;for(;n.tagName!="DIV";)n=n.parentElement;let r=Array.from(this.root.value.children).indexOf(n),c=this.lineList[r];T.handleInnerHtml(c,n,!0,this.onGetLineConfigType),(o=this.onUploadFileFunc)==null||o.call(this,e,(d,a)=>{let p=c.arr[c.selectStartIndexPath[0]],m={value:d,link:a,type:E.IMAGE},h;if(p){let u=JSON.parse(JSON.stringify(p));u.value=u.value.substring(c.selectStartIndexPath[1]);let y=[...c.arr.slice(c.selectStartIndexPath[0]+1)];u.type!=E.IMAGE&&y.unshift(u),p.value=p.value.substring(0,c.selectStartIndexPath[1]),c.arr.splice(c.selectStartIndexPath[0]+1,0,m),h=c.arr.length-1,c.arr=c.arr.concat(y)}else c.arr=[m],h=0;T.fixLine(c),f.nextTick(()=>{let u=document.createRange();u.selectNode(n.childNodes[h]),u.collapse(!1),i.removeAllRanges(),i.addRange(u)})})}}else if(s!=null&&s.includes("text/html")){t.stopPropagation(),t.preventDefault();let e=document.createElement("div");e.innerHTML=t.clipboardData.getData("text/html");let i=e.getElementsByTagName("div"),l=!1;e.childNodes.length==2&&e.firstChild.tagName==="META"&&e.childNodes[1].tagName==="DIV"&&e.childNodes[1].getAttribute("copy")==="teamlinker"&&(l=!0);let n=window.getSelection(),c=n.getRangeAt(0).startContainer;for(;c.tagName!="DIV";)c=c.parentElement;let d=Array.from(this.root.value.children).indexOf(c),a=this.lineList[Array.from(this.root.value.children).indexOf(c)];if(T.handleInnerHtml(a,c,!0,this.onGetLineConfigType),l){let p,m=[];for(let h=0;h<i.length;h++){let u={arr:[],selectEndIndexPath:[],selectStartIndexPath:[]};if(T.handleInnerHtml(u,i[h],!1,this.onGetLineConfigType),h==0||h==i.length-1)if(h==0){let y="",w=!1;if(a.arr.forEach(b=>{y+=b.value,b.type==E.IMAGE&&(w=!0)}),!y&&!w)this.lineList.splice(this.lineList.indexOf(a),1,u);else{let b=a.arr[a.selectStartIndexPath[0]],L=JSON.parse(JSON.stringify(b));L.value=L.value.substring(a.selectStartIndexPath[1]),p=[...a.arr.slice(a.selectStartIndexPath[0]+1)],L.type!=E.IMAGE&&p.unshift(L),b.value=b.value.substring(0,a.selectStartIndexPath[1]),a.arr.splice(a.selectStartIndexPath[0]+1,a.arr.length,...u.arr),T.fixLine(a)}if(i.length==1){let b;p&&(b={endItem:a.arr[a.arr.length-1]},a.arr=a.arr.concat(p),T.fixLine(a,b)),m=[d+h,b?a.arr.indexOf(b.endItem):u.arr.length-1]}}else{let y;p&&(y={endItem:u.arr[u.arr.length-1]},u.arr=u.arr.concat(p),T.fixLine(u,y)),this.lineList.splice(d+h,0,u),m=[d+h,y?u.arr.indexOf(y.endItem):u.arr.length-1]}else this.lineList.splice(d+h,0,u)}f.nextTick(()=>{let h=window.getSelection(),u=document.createRange();u.selectNode(this.root.value.children[m[0]].childNodes[m[1]]),u.collapse(!1),h.removeAllRanges(),h.addRange(u)})}else{let p=a.arr[a.selectStartIndexPath[0]];if(p){let m=(p.value.substring(0,a.selectStartIndexPath[1])+e.innerText).length;p.value=p.value.substring(0,a.selectStartIndexPath[1])+e.innerText+p.value.substring(a.selectStartIndexPath[1]),f.nextTick(()=>{let h=c.childNodes[a.selectStartIndexPath[0]],u=document.createRange();h.nodeType==Node.TEXT_NODE?(u.setStart(h,m),u.setEnd(h,m)):h.nodeType==Node.ELEMENT_NODE&&(h.tagName=="IMG"?(u.selectNode(h),u.collapse(!1)):(u.setStart(h.firstChild,m),u.setEnd(h.firstChild,m))),n.removeAllRanges(),n.addRange(u)})}else a.arr.push({value:e.innerText,type:E.TEXT,style:{}}),f.nextTick(()=>{let m=c.firstChild,h=document.createRange();h.selectNodeContents(m),h.collapse(!1),n.removeAllRanges(),n.addRange(h)})}}}onMouseOver(t){let s=t.target;if(s.tagName=="IMG"){let o=s.offsetParent,e=o.getBoundingClientRect(),i=s.getBoundingClientRect(),l=i.left-e.left,n=i.top-e.top,r=s.offsetWidth,c=s.offsetHeight;this.imageHelperElement||(this.imageHelperElement=document.createElement("div"),o.appendChild(this.imageHelperElement),this.resizeObserver=new ResizeObserver((d,a)=>{for(let p of d)this.resizeImage&&(this.resizeImage.width=p.contentRect.width)})),this.imageHelperElement.style.border="1px solid blue",this.imageHelperElement.style.position="absolute",this.imageHelperElement.style.left=l+"px",this.imageHelperElement.style.top=n+"px",this.imageHelperElement.style.width=r+"px",this.imageHelperElement.style.height=c+"px",this.imageHelperElement.style.overflow="hidden",this.imageHelperElement.style.resize="both",this.imageHelperElement.style.display="block",this.resizeImage=s,this.resizeObserver.observe(this.imageHelperElement)}else this.imageHelperElement&&(this.imageHelperElement.style.display="none",this.resizeObserver.unobserve(this.imageHelperElement)),this.resizeImage&&(this.resizeImage=null)}onKeyDown(t){if((t.metaKey||t.ctrlKey)&&t.key=="a"){t.stopPropagation(),t.preventDefault();let s=window.getSelection(),e=s.getRangeAt(0).startContainer;for(;e.tagName!="DIV";)e=e.parentElement;let i=Array.from(this.root.value.children).indexOf(e),l=this.lineList[i];T.handleInnerHtml(l,e,!1,this.onGetLineConfigType),this.selectElementList=Array.from(this.root.value.children),f.nextTick(()=>{let n=document.createRange(),r,c;for(let d=0;d<this.root.value.childNodes.length;d++){let a=this.root.value.childNodes[d];for(let p=0;p<a.childNodes.length;p++){let m=a.childNodes[p];if(m){r=m;break}}if(r)break}for(let d=this.root.value.childNodes.length-1;d>=0;d--){let a=this.root.value.childNodes[d];for(let p=a.childNodes.length-1;p>=0;p--){let m=a.childNodes[p];if(m){c=m;break}}if(c)break}r&&c&&(n.setStartBefore(r),n.setEndAfter(c),s.removeAllRanges(),s.addRange(n))})}if(t.key==="/"){let o=window.getSelection().getRangeAt(0),e=o.getBoundingClientRect();if(e.left==0&&e.top==0&&e.width==0&&e.height==0){if(o.startContainer.tagName=="DIV"&&o.startOffset!==0)return;e=o.startContainer.getBoundingClientRect()}let i=e.right+e.width,l=e.bottom,n,r;i>160?n=e.left:n=e.left-150,document.body.clientHeight-l>210?r=e.top+e.height:r=e.top-200,this.popMenuPosition.value={left:n,top:r}}else this.popMenuPosition.value=null;if(t.key==="@"){if(!this.onQuoteListFunc)return;let o=window.getSelection().getRangeAt(0),e=o.getBoundingClientRect();if(e.left==0&&e.top==0&&e.width==0&&e.height==0){if(o.startContainer.tagName=="DIV"&&o.startOffset!==0)return;e=o.startContainer.getBoundingClientRect()}let i=e.right+e.width,l=e.bottom,n,r;i>160?n=e.left:n=e.left-150,document.body.clientHeight-l>210?r=e.top+e.height:r=e.top-200,this.quotePosition.value={left:n,top:r}}else this.clearQuote();if(t.key=="ArrowDown"){let s=window.getSelection(),o=s.getRangeAt(0),e=o.startOffset,i=o.startContainer,l=[];l.unshift(e);let n=i.parentElement;if(i.tagName=="DIV"?l.unshift(0):n.tagName=="DIV"?(e=Array.from(n.childNodes).indexOf(i),l.unshift(e),i=n):(e=Array.from(n.parentElement.childNodes).indexOf(n),l.unshift(e),i=n.parentElement),o.collapsed&&(i.childNodes.length==0||l[0]==i.childNodes.length-1&&l[1]==i.lastChild.textContent.length)){t.stopPropagation(),t.preventDefault();let r=Array.from(this.root.value.children).indexOf(i);if(r<this.lineList.length-1){let c=document.createRange();c.selectNodeContents(this.root.value.children[r+1]),c.collapse(!0),s.removeAllRanges(),s.addRange(c)}}}else if(t.key=="ArrowUp"){let s=window.getSelection(),o=s.getRangeAt(0),e=o.startOffset,i=o.startContainer,l=[];if(l.unshift(e),i.tagName=="DIV")l.unshift(0);else{let n=i.parentElement;n.tagName=="DIV"?(e=Array.from(n.childNodes).indexOf(i),l.unshift(e),i=n):(e=Array.from(n.parentElement.childNodes).indexOf(n),l.unshift(e),i=n.parentElement)}if(o.collapsed&&l[0]==0&&l[1]==0){t.stopPropagation(),t.preventDefault();let n=Array.from(this.root.value.children).indexOf(i);if(n>0){let r=document.createRange();r.selectNodeContents(this.root.value.children[n-1]),r.collapse(!1),s.removeAllRanges(),s.addRange(r)}}}}getSelectionItemList(){let t=[];this.selectElementList.forEach(m=>{t.push(this.lineList[Array.from(this.root.value.children).indexOf(m)])});let o=window.getSelection().getRangeAt(0),e=o.startOffset,i=o.endOffset,l=o.startContainer,n=o.endContainer,r=[],c=[];if(l.tagName=="DIV")r=[e,0];else{r.unshift(e);let m=l.parentElement;m.tagName=="DIV"?(e=Array.from(m.childNodes).indexOf(l),r.unshift(e),l=m):(e=Array.from(m.parentElement.childNodes).indexOf(m),r.unshift(e),l=m.parentElement)}if(n.tagName=="DIV")c=[i,n.childNodes[i]?n.childNodes[i].textContent.length:0];else{c.unshift(i);let m=n.parentElement;m.tagName=="DIV"?(i=Array.from(m.childNodes).indexOf(n),c.unshift(i),n=m):(i=Array.from(m.parentElement.childNodes).indexOf(m),c.unshift(i),n=m.parentElement)}let d=t[0];d.selectStartIndexPath=r;let a=t[t.length-1];a.selectEndIndexPath=c;let p=[];if(t.length==1)T.handleInnerHtml(t[0],l,!1,this.onGetLineConfigType),p=[{line:t[0],data:[...t[0].arr.slice(r[0],c[0]+1)]}];else for(let m of t){let h=p.find(u=>u.line===m);if(h||(h={line:m,data:[]},p.push(h)),m==d){T.handleInnerHtml(m,l,!1,this.onGetLineConfigType);for(let u=r[0];u<d.arr.length;u++){let y=d.arr[u];h.data.push(y)}}else if(m==a){T.handleInnerHtml(m,n,!1,this.onGetLineConfigType);for(let u=0;u<=c[0];u++){let y=a.arr[u];y&&h.data.push(y)}}else T.handleInnerHtml(m,this.root.value.children[this.lineList.indexOf(m)],!1,this.onGetLineConfigType),m.arr.forEach(u=>{h.data.push(u)})}return p}getCurrentInfo(){let o=window.getSelection().getRangeAt(0).startContainer,e=o;for(;e.tagName!="DIV";)e=e.parentElement;let i=Array.from(this.root.value.children).indexOf(e),l=this.lineList[i],n,r;return o!=e&&(r=Array.from(e.childNodes).indexOf(o),n=l.arr[r]),{element:e,line:l,lineIndex:i,item:n,itemIndex:r}}}const Z={style:{position:"absolute",boxShadow:"0px 0px 2px 2px rgba(169, 169, 169, 0.2)",backgroundColor:"white",border:"1px solid rgba(169, 169, 169, 0.2)",width:"150px",height:"200px",overflow:"auto",outlineWidth:"0","z-index":"10000"},tabIndex:"-1"},ee=["onMousedown"],te=f.defineComponent({__name:"popMenu",props:{objEditor:{},popMenuList:{}},setup(x){const t=x,s=f.ref(t.popMenuList??[]),o=async e=>{var n,r;let i=t.objEditor.getSelectionItemList(),l=JSON.parse(JSON.stringify(i[0].line.selectStartIndexPath));(r=(n=t.objEditor).onPopMenuClickFunc)==null||r.call(n,e.type,c=>{let d=i[0].line,a=t.objEditor.getRoot().value.children[t.objEditor.getLineList().indexOf(d)],p=d.arr[l[0]],m=JSON.parse(JSON.stringify(p));m.value=p.value.substring(l[1]),p.value=p.value.substring(0,l[1]-1),d.arr.splice(l[0]+1,0,c,m);let h={startIndex:l[0]+1};T.fixLine(d,h),f.nextTick(()=>{let u=window.getSelection(),y=document.createRange();y.setStartAfter(a.childNodes[h.startIndex]??a.lastChild),y.setEndAfter(a.childNodes[h.startIndex]??a.lastChild),u.removeAllRanges(),u.addRange(y)})})};return(e,i)=>(f.openBlock(),f.createElementBlock("div",Z,[(f.openBlock(!0),f.createElementBlock(f.Fragment,null,f.renderList(s.value,(l,n)=>(f.openBlock(),f.createElementBlock("div",{class:"item",style:f.normalizeStyle([{height:"35px",display:"flex","align-items":"center","justify-content":"center",cursor:"pointer"},{borderBottom:n!==s.value.length-1?"rgb(241,241,241) 1px solid":""}]),key:l.type,onMousedown:r=>o(l)},f.toDisplayString(l.title),45,ee))),128))]))}}),q=(x,t)=>{const s=x.__vccOpts||x;for(const[o,e]of t)s[o]=e;return s},le=q(te,[["__scopeId","data-v-f6e1fb69"]]),ne={style:{height:"30px","border-bottom":"1px lightgray solid"}},ie=["onClick"],se=["src"],re=q(f.defineComponent({__name:"quote",props:{objEditor:{},quoteType:{},position:{}},setup(x){const t=x,s=f.ref(""),o=f.ref(),e=f.ref([]);let i,l;const n=async()=>{var a,p;(p=(a=t.objEditor).onQuoteListFunc)==null||p.call(a,s.value,m=>{e.value=m})},r=a=>{t.objEditor.clearQuote()},c=a=>{i||(i=t.objEditor.getSelectionItemList(),l=JSON.parse(JSON.stringify(i[0].line.selectStartIndexPath)))},d=async a=>{t.objEditor.clearQuote();let p=i[0].line,m=t.objEditor.getRoot().value.children[t.objEditor.getLineList().indexOf(p)],h=p.arr[l[0]],u=JSON.parse(JSON.stringify(h));u.value=h.value.substring(l[1]),h.value=h.value.substring(0,l[1]-1);let y={type:t.quoteType,value:a.value,label:a.label};p.arr.splice(l[0]+1,0,y,u);let w={startIndex:l[0]+1};T.fixLine(p,w),f.nextTick(()=>{let b=window.getSelection(),L=document.createRange();L.setStartAfter(m.childNodes[w.startIndex]??m.lastChild),L.setEndAfter(m.childNodes[w.startIndex]??m.lastChild),b.removeAllRanges(),b.addRange(L)})};return f.onBeforeMount(()=>{n()}),(a,p)=>(f.openBlock(),f.createElementBlock("div",{style:{width:"100%",height:"100%",position:"absolute","z-index":"10000",left:"0px",top:"0px"},onClick:f.withModifiers(r,["self"])},[f.createElementVNode("div",{style:f.normalizeStyle([{width:"150px",height:"200px",padding:"5px","box-sizing":"border-box",position:"absolute","box-shadow":"0px 0px 2px 2px rgba(169, 169, 169, 0.2)",border:"1px solid rgba(169, 169, 169, 0.2)","background-color":"white",overflow:"auto","outline-width":"0"},{left:a.position.left+"px",top:a.position.top+"px"}]),ref_key:"rootEle",ref:o,onMousedown:c},[f.createElementVNode("div",ne,[f.withDirectives(f.createElementVNode("input",{"onUpdate:modelValue":p[0]||(p[0]=m=>s.value=m),style:{width:"100%","box-sizing":"border-box"},onInput:n},null,544),[[f.vModelText,s.value]])]),(f.openBlock(!0),f.createElementBlock(f.Fragment,null,f.renderList(e.value,m=>(f.openBlock(),f.createElementBlock("div",{class:"hover",style:{height:"40px",display:"flex","align-items":"center"},onClick:h=>d(m)},[m.photo?(f.openBlock(),f.createElementBlock("img",{key:0,style:{width:"30px",height:"30px","border-radius":"15px"},src:m.photo},null,8,se)):f.createCommentVNode("",!0),f.createTextVNode("  "+f.toDisplayString(m.label),1)],8,ie))),256))],36)]))}}),[["__scopeId","data-v-dd631648"]]),oe=["onBlur","innerHTML","onKeydown","onFocus","placeholder"],ae=["innerHTML"],U=q(f.defineComponent({__name:"index",props:{readonly:{type:Boolean},modelValue:{},border:{type:Boolean},popMenuList:{},placeholder:{},quoteType:{}},emits:["update:modelValue","uploadFile","popMenuClick","customAnchorClick","quoteList","metaEnter","linkClick","setLineConfigType","getLineConfigType"],setup(x,{expose:t,emit:s}){const o=s,e=x,i=f.ref(),l=f.ref([]);let n=[0,0,0];const r=f.ref(),c=f.ref(),d=new Y(i,r,c);d.onSetLineConfigType=(g,I)=>{o("setLineConfigType",g,I)},d.onGetLineConfigType=(g,I)=>{o("getLineConfigType",g,I)},d.onUploadFileFunc=(g,I)=>{o("uploadFile",g,I)},d.onPopMenuClickFunc=(g,I)=>{o("popMenuClick",g,I)},d.onCustomMenuClickFunc=(g,I,S,k)=>{o("customAnchorClick",g,I,S,k)},f.getCurrentInstance().vnode.props.onQuoteList&&(d.onQuoteListFunc=(g,I)=>{o("quoteList",g,I)});const a=d.getLineList();let p=[],m=!1;f.watch(a,()=>{o("update:modelValue",a)},{deep:!0}),f.watch(()=>e.modelValue,(g,I,S)=>{if(d.setLineList(e.modelValue),a.length==0&&d.addLine(""),I&&I.length>0&&!m){let k=JSON.parse(JSON.stringify(I));k.forEach(R=>{delete R.selectStartIndexPath,delete R.selectEndIndexPath});let v=JSON.stringify(k);if(p.length==0)p.unshift(k);else{let R=p[0];JSON.stringify(R)!==v&&p.unshift(k)}p.length>10&&p.pop()}else m===!0&&(m=!1)},{deep:!0,immediate:!0});const h=(g,I)=>{d.onFocus(g,I)},u=g=>{d.onDbClick(g)},y=(g,I)=>{d.onBlur(g,I)},w=(g,I,S)=>{S.metaKey?(T.handleInnerHtml(g,S.currentTarget,!1,d.onGetLineConfigType),f.nextTick(()=>{o("metaEnter")})):d.onEnter(g,I,S)},b=(g,I,S)=>{d.onDelete(g,I,S)},L=g=>{d.onMouseDown(g)},M=g=>{d.onMouseMove(g)},C=()=>{let g=window.getSelection();if(g.rangeCount==0)return;let I=g.getRangeAt(0),S=I.startOffset;n=[];let k=I.startContainer;if(k.tagName==="DIV")n=[0,S],n.unshift(Array.from(k.parentElement.children).indexOf(k));else{n=[S];let v=k.parentElement;v.tagName=="DIV"?(S=Array.from(v.childNodes).indexOf(k),n.unshift(S),k=v):(S=Array.from(v.parentElement.childNodes).indexOf(v),n.unshift(S),k=v.parentElement),n.unshift(Array.from(k.parentElement.children).indexOf(k))}},F=g=>{C()},G=g=>{d.onMouseUp(g),C()},z=g=>{d.onPaste(g)},N=g=>{e.readonly||d.onMouseOver(g)},O=g=>{d.onCopy(g)},P=g=>{if(!e.readonly&&(d.onKeyDown(g),g.key=="z"&&(g.metaKey||g.ctrlKey))){if(g.stopPropagation(),g.preventDefault(),p.length>0){let I=p.shift();d.setLineList(I)}m=!0}},H=g=>{if(d.onClick(g),e.readonly){let I=g.target,S=I.getAttribute("type");if(I.tagName==="A"&&S){let k=I.getAttribute("value");o("linkClick",Number(S),k,g.x,g.y)}}},V=g=>{if(g.length==0)return;let I=[];g.forEach(X=>{I.push(X,{type:E.TEXT,value:"&nbsp;"})});let S=a[n[0]],k=l.value[n[0]];T.handleInnerHtml(S,k,!1,d.onGetLineConfigType);let v=S.arr[n[1]],R;if(v){let X=JSON.parse(JSON.stringify(v));X.value=v.value.substring(n[2]),v.value=v.value.substring(0,n[2]),S.arr.splice(n[1]+1,0,...I,X),R={endIndex:n[1]+I.length}}else S.arr.push(...I),R={endIndex:n[1]+I.length-1};T.fixLine(S,R),f.nextTick(()=>{let X=window.getSelection(),J=document.createRange();J.setStart(k.childNodes[R.endIndex],1),J.setEnd(k.childNodes[R.endIndex],1),X.removeAllRanges(),X.addRange(J)})};return f.onBeforeUnmount(()=>{d.clear()}),t({insertConfig:V}),(g,I)=>{var S;return f.openBlock(),f.createElementBlock(f.Fragment,null,[f.createElementVNode("div",f.mergeProps({ref_key:"root",ref:i,onMouseover:N,onKeydown:P,style:[{padding:"10px"},{border:g.border?"border: 1px solid lightgray;":"0px"}],onKeyup:F,onCopy:O},g.$attrs),[g.readonly?(f.openBlock(!0),f.createElementBlock(f.Fragment,{key:1},f.renderList(f.unref(a),(k,v)=>(f.openBlock(),f.createElementBlock("div",{onClick:H,key:v+1,innerHTML:f.unref(T).handle(k,f.unref(d).onSetLineConfigType),style:{"line-height":"1.5","min-height":"21px"}},null,8,ae))),128)):(f.openBlock(!0),f.createElementBlock(f.Fragment,{key:0},f.renderList(f.unref(a),(k,v)=>(f.openBlock(),f.createElementBlock("div",{key:v,contenteditable:"true",onBlur:R=>y(k,R),ref_for:!0,ref_key:"elementList",ref:l,innerHTML:f.unref(T).handle(k,f.unref(d).onSetLineConfigType),onKeydown:[f.withKeys(R=>w(k,v,R),["enter"]),f.withKeys(R=>b(v,k,R),["delete"])],style:{"line-height":"1.5"},onFocus:R=>h(k,R),onMousedown:L,onMouseup:G,onMousemove:M,onDblclick:u,onPaste:z,onClick:H,placeholder:g.placeholder??"type something"},null,40,oe))),128))],16),r.value&&((S=g.popMenuList)==null?void 0:S.length)>0?(f.openBlock(),f.createBlock(f.Teleport,{key:0,to:"body"},[f.createVNode(le,{"obj-editor":f.unref(d),"pop-menu-list":g.popMenuList,style:f.normalizeStyle({left:r.value.left+"px",top:r.value.top+"px"})},null,8,["obj-editor","pop-menu-list","style"])])):f.createCommentVNode("",!0),c.value&&g.quoteType!=null?(f.openBlock(),f.createBlock(f.Teleport,{key:1,to:"body"},[f.createVNode(re,{"obj-editor":f.unref(d),"quote-type":g.quoteType,position:c.value},null,8,["obj-editor","quote-type","position"])])):f.createCommentVNode("",!0)],64)}}}),[["__scopeId","data-v-7636bc68"]]),de={install(x,t){x.component("TLEditor",U)}};D.EEditor_Content_Line_Config_Type=E,D.TLEditor=U,D.default=de,Object.defineProperties(D,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
